# =============================================================================
# Deploy Workflow - Deploys to DigitalOcean App Platform
# =============================================================================
# Triggers on push to main branch.
# Builds, tests, and deploys all services.

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_schema:
        description: 'Deploy ClickHouse schema updates'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  DO_APP_NAME: lynex

jobs:
  # ===========================================================================
  # Build and Test
  # ===========================================================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          pip install pytest pytest-asyncio ruff

      - name: Lint Python services
        run: |
          for service in ingest-api processor ui-backend billing; do
            echo "Linting $service..."
            cd services/$service
            ruff check . --ignore E501 || true
            cd ../..
          done

      - name: Build frontend
        run: |
          cd web
          npm ci || npm install
          npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_SENTRY_ENVIRONMENT: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web/dist

  # ===========================================================================
  # Deploy to DigitalOcean
  # ===========================================================================
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get App ID
        id: get-app
        run: |
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "$DO_APP_NAME" | awk '{print $1}')
          if [ -z "$APP_ID" ]; then
            echo "App not found, creating new app..."
            doctl apps create --spec .do/app.yaml --wait
            APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "$DO_APP_NAME" | awk '{print $1}')
          fi
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "App ID: $APP_ID"

      - name: Update App Spec
        run: |
          doctl apps update ${{ steps.get-app.outputs.app_id }} --spec .do/app.yaml

      - name: Deploy App
        run: |
          doctl apps create-deployment ${{ steps.get-app.outputs.app_id }} --wait

      - name: Get Deployment URL
        id: get-url
        run: |
          URL=$(doctl apps get ${{ steps.get-app.outputs.app_id }} --format LiveURL --no-header)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

    outputs:
      app_id: ${{ steps.get-app.outputs.app_id }}
      url: ${{ steps.get-url.outputs.url }}

  # ===========================================================================
  # Deploy ClickHouse Schema
  # ===========================================================================
  deploy-schema:
    name: Deploy ClickHouse Schema
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.deploy_schema == 'true' || contains(github.event.head_commit.message, '[schema]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ClickHouse client
        run: |
          curl https://clickhouse.com/ | sh
          sudo ./clickhouse install

      - name: Run schema migrations
        run: |
          clickhouse-client \
            --host ${{ secrets.CLICKHOUSE_HOST }} \
            --port 9000 \
            --user default \
            --password ${{ secrets.CLICKHOUSE_PASSWORD }} \
            --multiquery < infra/clickhouse/schema.sql
        continue-on-error: true

  # ===========================================================================
  # Smoke Tests
  # ===========================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: pip install httpx pytest

      - name: Wait for deployment
        run: sleep 30

      - name: Run smoke tests
        run: |
          BASE_URL="${{ needs.deploy.outputs.url }}"
          
          echo "Testing health endpoints..."
          
          # Test ingest API health
          curl -f "${BASE_URL}/ingest/health" || echo "Ingest API health check failed"
          
          # Test UI backend health
          curl -f "${BASE_URL}/api/health" || echo "UI Backend health check failed"
          
          # Test frontend
          curl -f "${BASE_URL}" || echo "Frontend check failed"
          
          echo "Smoke tests completed!"
        continue-on-error: true

      - name: Run E2E tests
        run: |
          cd tests/e2e
          pytest -v || echo "No E2E tests found"
        env:
          BASE_URL: ${{ needs.deploy.outputs.url }}
        continue-on-error: true

  # ===========================================================================
  # Notify on Failure
  # ===========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: failure()
    
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Deployment Failed - ${context.sha.substring(0, 7)}`,
              body: `## Deployment Failure Alert
              
              **Commit:** ${context.sha}
              **Branch:** ${context.ref}
              **Author:** @${context.actor}
              **Workflow:** [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ### Next Steps
              1. Check the workflow logs
              2. Fix the issue and push a new commit
              3. Or manually trigger a redeploy from Actions tab`,
              labels: ['deployment', 'bug']
            })
        continue-on-error: true

  # ===========================================================================
  # Notify on Success
  # ===========================================================================
  notify-success:
    name: Notify on Success
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: success()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ needs.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
